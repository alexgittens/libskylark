<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>IO in libSkylark &mdash; libSkylark  documentation</title>
    
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="libSkylark  documentation" href="index.html" />
    <link rel="next" title="Contributing" href="contributing.html" />
    <link rel="prev" title="Machine Learning" href="ml.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="index.html">
          <span>libSkylark  documentation</span></a></h1>
        <h2 class="heading"><span>IO in libSkylark</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="ml.html">Machine Learning</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="contributing.html">Contributing</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="io-in-libskylark">
<h1>IO in libSkylark<a class="headerlink" href="#io-in-libskylark" title="Permalink to this headline">¶</a></h1>
<div class="section" id="io-from-c">
<h2>IO from C++<a class="headerlink" href="#io-from-c" title="Permalink to this headline">¶</a></h2>
<p>Currently, IO from the C++ layer is implemented in libskylark/ml/io.hpp.</p>
<div class="section" id="reading">
<h3>Reading<a class="headerlink" href="#reading" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="read__boost::mpi::communicatorCR.i.ss.InputTypeR.LabelTypeR.i">
void <tt class="descname">read</tt><big>(</big>const boost::mpi::communicator&amp; <em>comm</em>, int <em>fileformat</em>, std::string <em>filename</em>, InputType&amp; <em>X</em>, LabelType&amp; <em>Y</em>, int <em>d</em><em>=0</em><big>)</big><a class="headerlink" href="#read__boost::mpi::communicatorCR.i.ss.InputTypeR.LabelTypeR.i" title="Permalink to this definition">¶</a></dt>
<dd><p>Reads data from <cite>filename</cite> as a pair of matrices <cite>X</cite> and <cite>Y</cite>. Data are in the form of instances each carrying a label; an instance in turn consists of a series of feature/value pairs. Feature/value pairs are the column indices/entries for matrix <cite>X</cite> with its row indices coming from a running index of the instances (the minimum number of features is <cite>d</cite>). Matrix <cite>Y</cite> carries the vector of successive labels corresponding to this running index. <cite>fileformat</cite> can have any of the following values of <cite>FileFormatType</cite> enum (as defined in libskylark/ml/options.hpp):</p>
<ul class="simple">
<li>HDF5_DENSE</li>
<li>HDF5_SPARSE</li>
<li>LIBSVM_DENSE</li>
<li>LIBSVM_SPARSE</li>
</ul>
</dd></dl>

<p><cite>*_DENSE</cite> correspond to the case of El::Matrix&lt;T&gt; (dense) matrix <cite>X</cite>; <cite>*_SPARSE</cite> is for the skylark::base::sparse_matrix_t&lt;T&gt; (sparse) matrix <cite>X</cite>.
<cite>HDF5_*</cite> are for <a class="reference external" href="http://www.hdfgroup.org/HDF5/">Hierarchical Data Format, version 5 (HDF5)</a> files  while <cite>LIBSVM_*</cite> are for <a class="reference external" href="http://www.csie.ntu.edu.tw/~cjlin/libsvm/">Library for Support Vector Machines (LIBSVM)</a> ones.</p>
<p><strong>HDF5-specific routines</strong></p>
<dl class="function">
<dt id="read_hdf5__boost::mpi::communicatorCR.ss.El::Matrix:double:R.El::Matrix:double:R.i">
void <tt class="descname">read_hdf5</tt><big>(</big>const boost::mpi::communicator&amp; <em>comm</em>, std::string <em>filename</em>, El::Matrix&lt;double&gt;&amp; <em>X</em>, El::Matrix&lt;double&gt;&amp; <em>Y</em>, int <em>blocksize</em><em>=10000</em><big>)</big><a class="headerlink" href="#read_hdf5__boost::mpi::communicatorCR.ss.El::Matrix:double:R.El::Matrix:double:R.i" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="function">
<dt id="read_hdf5__boost::mpi::communicatorCR.ss.skylark::base::sparse_matrix_t:double:R.El::Matrix:double:R.i">
void <tt class="descname">read_hdf5</tt><big>(</big>const boost::mpi::communicator&amp; <em>comm</em>, std::string <em>filename</em>, skylark::base::sparse_matrix_t&lt;double&gt;&amp; <em>X</em>, El::Matrix&lt;double&gt;&amp; <em>Y</em>, int <em>min_d</em><em>=0</em><big>)</big><a class="headerlink" href="#read_hdf5__boost::mpi::communicatorCR.ss.skylark::base::sparse_matrix_t:double:R.El::Matrix:double:R.i" title="Permalink to this definition">¶</a></dt>
<dd><p>Reads datasets <cite>X</cite> and <cite>Y</cite> from HDF5 <cite>filename</cite> as a pair of matrices <cite>X</cite>, <cite>Y</cite>. Instances are read in bunches of <cite>blocksize</cite> each; <cite>min_d</cite> is the minimum number of features.</p>
</dd></dl>

<p><strong>LIBSVM-specific routines</strong></p>
<dl class="function">
<dt id="read_libsvm__boost::mpi::communicatorCR.ss.El::Matrix:T:R.El::Matrix:T:R.i.i">
void <tt class="descname">read_libsvm</tt><big>(</big>const boost::mpi::communicator&amp; <em>comm</em>, std::string <em>filename</em>, El::Matrix&lt;T&gt;&amp; <em>X</em>, El::Matrix&lt;T&gt;&amp; <em>Y</em>, int <em>min_d</em><em>=0</em>, int <em>blocksize</em><em>=10000</em><big>)</big><a class="headerlink" href="#read_libsvm__boost::mpi::communicatorCR.ss.El::Matrix:T:R.El::Matrix:T:R.i.i" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="function">
<dt id="read_libsvm__boost::mpi::communicatorCR.ss.skylark::base::sparse_matrix_t:T:R.El::Matrix:T:R.i">
void <tt class="descname">read_libsvm</tt><big>(</big>const boost::mpi::communicator&amp; <em>comm</em>, std::string <em>filename</em>, skylark::base::sparse_matrix_t&lt;T&gt;&amp; <em>X</em>, El::Matrix&lt;T&gt;&amp; <em>Y</em>, int <em>min_d</em><em>=0</em><big>)</big><a class="headerlink" href="#read_libsvm__boost::mpi::communicatorCR.ss.skylark::base::sparse_matrix_t:T:R.El::Matrix:T:R.i" title="Permalink to this definition">¶</a></dt>
<dd><p>Reads data from LIBSVM <cite>filename</cite> as a pair of matrices <cite>X</cite>, <cite>Y</cite>. Instances are read in bunches of <cite>blocksize</cite> each; <cite>min_d</cite> is the minimum number of features.</p>
</dd></dl>

<p><strong>Utility routines</strong></p>
<dl class="function">
<dt id="read_hdf5_dataset__H5::H5FileR.ss.iP.i.i">
void <tt class="descname">read_hdf5_dataset</tt><big>(</big>H5::H5File&amp; <em>file</em>, std::string <em>name</em>, int* <em>buffer</em>, int <em>offset</em>, int <em>count</em><big>)</big><a class="headerlink" href="#read_hdf5_dataset__H5::H5FileR.ss.iP.i.i" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="function">
<dt id="read_hdf5_dataset__H5::H5FileR.ss.doubleP.i.i">
void <tt class="descname">read_hdf5_dataset</tt><big>(</big>H5::H5File&amp; <em>file</em>, std::string <em>name</em>, double* <em>buffer</em>, int <em>offset</em>, int <em>count</em><big>)</big><a class="headerlink" href="#read_hdf5_dataset__H5::H5FileR.ss.doubleP.i.i" title="Permalink to this definition">¶</a></dt>
<dd><p>Reads <cite>count</cite> entries from the <cite>name</cite> dataset in HDF5 <cite>file</cite> starting at <cite>offset</cite> and collects them into <cite>buffer</cite>.</p>
</dd></dl>

<dl class="function">
<dt id="read_model_file__ss.El::Matrix:double:R">
void <tt class="descname">read_model_file</tt><big>(</big>std::string <em>filename</em>, El::Matrix&lt;double&gt;&amp; <em>W</em><big>)</big><a class="headerlink" href="#read_model_file__ss.El::Matrix:double:R" title="Permalink to this definition">¶</a></dt>
<dd><p>Reads the values from model file <cite>filename</cite> into matrix <cite>W</cite>; model file is expected to start with a line of the form:
<cite># Dimensions m n</cite> for an <cite>m x n</cite> matrix <cite>W</cite> followed by lines containing the values of successive rows of the matrix.</p>
</dd></dl>

<dl class="function">
<dt id="read_header__boost::mpi::communicatorCR.ss">
std::string <tt class="descname">read_header</tt><big>(</big>const boost::mpi::communicator&amp; <em>comm</em>, std::string <em>filename</em><big>)</big><a class="headerlink" href="#read_header__boost::mpi::communicatorCR.ss" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the first line of <cite>filename</cite>.</p>
</dd></dl>

</div>
<div class="section" id="writing">
<h3>Writing<a class="headerlink" href="#writing" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="write_hdf5__boost::mpi::communicatorCR.ss.El::Matrix:double:R.El::Matrix:double:R">
int <tt class="descname">write_hdf5</tt><big>(</big>const boost::mpi::communicator&amp; <em>comm</em>, std::string <em>filename</em>, El::Matrix&lt;double&gt;&amp; <em>X</em>, El::Matrix&lt;double&gt;&amp; <em>Y</em><big>)</big><a class="headerlink" href="#write_hdf5__boost::mpi::communicatorCR.ss.El::Matrix:double:R.El::Matrix:double:R" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="function">
<dt id="write_hdf5__ss.skylark::base::sparse_matrix_t:double:R.El::Matrix:double:R">
int <tt class="descname">write_hdf5</tt><big>(</big>std::string <em>filename</em>, skylark::base::sparse_matrix_t&lt;double&gt;&amp; <em>X</em>, El::Matrix&lt;double&gt;&amp; <em>Y</em><big>)</big><a class="headerlink" href="#write_hdf5__ss.skylark::base::sparse_matrix_t:double:R.El::Matrix:double:R" title="Permalink to this definition">¶</a></dt>
<dd><p>Writes feature/value pairs (in matrix <cite>X</cite>) and labels (in matrix <cite>Y</cite>) to the HDF5 <cite>filename</cite> and returns 0 to signal successfully completed operation.</p>
<blockquote>
<div><ul class="simple">
<li>For the case of dense matrix input <cite>X</cite> (El::Matrix&lt;double&gt; type) 2 datasets named <cite>X</cite> and <cite>Y</cite> are created in the file for all data.</li>
<li>For the case of sparse matrix <cite>X</cite> (skylark::base::sparse_matrix_t&lt;double&gt; type) 5 datasets are created in the file for all data: <cite>dimensions</cite> (for <cite>X</cite> matrix size), <cite>indptr</cite>, <cite>indices</cite>, <cite>values</cite> (for <cite>X</cite> matrix) and <cite>Y</cite> (for <cite>Y</cite> matrix).</li>
</ul>
</div></blockquote>
</dd></dl>

<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Currently IO from C++ and Python layers are not in sync; we expect a convergence of offerings from these layers as depending libraries (most notably Elemental) freeze their IO facilities and typical/common application IO scenaria are clearly identified.</p>
</div>
</div>
</div>
<div class="section" id="io-from-python">
<h2>IO from Python<a class="headerlink" href="#io-from-python" title="Permalink to this headline">¶</a></h2>
<div class="section" id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>

<span class="c"># prevent mpi4py from calling MPI_Finalize()</span>
<span class="kn">import</span> <span class="nn">mpi4py.rc</span>
<span class="n">mpi4py</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">finalize</span>   <span class="o">=</span> <span class="bp">False</span>

<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">elem</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">numpy.linalg</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">import</span> <span class="nn">skylark</span><span class="o">,</span> <span class="nn">skylark.io</span>

<span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>

<span class="c"># Create a HDF5 file and encapsulate this and its metadata in store</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;mydataset.hdf5&#39;</span> 
<span class="n">store</span> <span class="o">=</span> <span class="n">skylark</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">hdf5</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="s">&#39;MyDataset&#39;</span><span class="p">)</span>

<span class="c"># Create a 5 x 10 dat matrix and populate its store</span>
<span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
  <span class="n">m</span> <span class="o">=</span> <span class="mi">8</span>
  <span class="n">n</span> <span class="o">=</span> <span class="mi">10</span>
  <span class="n">matrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">81</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
  <span class="n">store</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
      
<span class="c"># Let all processes wait till the file is created.</span>
<span class="n">comm</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>
    
<span class="c"># All processes read into the file</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s">&#39;elemental-dense&#39;</span><span class="p">,</span> <span class="n">distribution</span><span class="o">=</span><span class="s">&#39;VC_STAR&#39;</span><span class="p">)</span>

<span class="c"># Check the Frobenius norm of the difference of generated/written and read-back matrices</span>
<span class="c"># Gather at root</span>
<span class="n">A_CIRC_CIRC</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">DistMatrix_d_CIRC_CIRC</span><span class="p">()</span>
<span class="n">elem</span><span class="o">.</span><span class="n">Copy</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">A_CIRC_CIRC</span><span class="p">)</span>

<span class="c"># Compute the norm at root and output</span>
<span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
  <span class="n">diff_fro_norm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">A_CIRC_CIRC</span><span class="o">.</span><span class="n">Matrix</span><span class="p">[:]</span> <span class="o">-</span> <span class="n">matrix</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="s">&#39;fro&#39;</span><span class="p">)</span>
  <span class="k">print</span> <span class="s">&#39;||generated_matrix - read_matrix||_F = </span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">diff_fro_norm</span> 
</pre></div>
</div>
</div>
</div>
<div class="section" id="sketch-serialization">
<h2>Sketch Serialization<a class="headerlink" href="#sketch-serialization" title="Permalink to this headline">¶</a></h2>
<p>As mentioned in Section <a class="reference internal" href="sketching.html#sketching-transforms-label"><em>Sketching Transforms</em></a> sketches can be
serialized using the following API:</p>
<dl class="function">
<dt id="to_ptreeC">
boost::property_tree::ptree <tt class="descname">to_ptree</tt><big>(</big><big>)</big><tt class="descclassname"> const</tt><a class="headerlink" href="#to_ptreeC" title="Permalink to this definition">¶</a></dt>
<dd><p>Serialize the sketch transform to a ptree structure.</p>
</dd></dl>

<dl class="function">
<dt id="from_ptree__boost::property_tree::ptreeCR">
<em class="property">static</em> sketch_transform_t* <tt class="descname">from_ptree</tt><big>(</big>const boost::property_tree::ptree&amp; <em>pt</em><big>)</big><a class="headerlink" href="#from_ptree__boost::property_tree::ptreeCR" title="Permalink to this definition">¶</a></dt>
<dd><p>Load a sketch transform from a ptree structure.</p>
</dd></dl>

<p>The following small snippet shows how a sketch can be serialized and loaded in
C++.</p>
<div class="highlight-cpp"><div class="highlight"><pre><span class="c1">//[&gt; 1. Create the sketching matrix and dump JSON &lt;]</span>
<span class="n">skylark</span><span class="o">::</span><span class="n">sketch</span><span class="o">::</span><span class="n">CWT_t</span><span class="o">&lt;</span><span class="n">DistMatrixType</span><span class="p">,</span> <span class="n">DistMatrixType</span><span class="o">&gt;</span>
    <span class="n">Sparse</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n_s</span><span class="p">,</span> <span class="n">context</span><span class="p">);</span>

<span class="c1">// dump to property tree</span>
<span class="n">boost</span><span class="o">::</span><span class="n">property_tree</span><span class="o">::</span><span class="n">ptree</span> <span class="n">pt</span> <span class="o">=</span> <span class="n">Sparse</span><span class="p">.</span><span class="n">get_data</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">to_ptree</span><span class="p">();</span>

<span class="c1">//[&gt; 2. Dump the JSON string to file &lt;]</span>
<span class="n">std</span><span class="o">::</span><span class="n">ofstream</span> <span class="n">out</span><span class="p">(</span><span class="s">&quot;sketch.json&quot;</span><span class="p">);</span>
<span class="n">write_json</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">pt</span><span class="p">);</span>
<span class="n">out</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>

<span class="c1">//[&gt; 3. Create a sketch from the JSON file. &lt;]</span>
<span class="n">std</span><span class="o">::</span><span class="n">ifstream</span> <span class="n">file</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">stringstream</span> <span class="n">json</span><span class="p">;</span>
<span class="n">file</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;sketch.json&quot;</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">in</span><span class="p">);</span>

<span class="n">boost</span><span class="o">::</span><span class="n">property_tree</span><span class="o">::</span><span class="n">ptree</span> <span class="n">json_tree</span><span class="p">;</span>
<span class="n">boost</span><span class="o">::</span><span class="n">property_tree</span><span class="o">::</span><span class="n">read_json</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">json_tree</span><span class="p">);</span>

<span class="n">skylark</span><span class="o">::</span><span class="n">sketch</span><span class="o">::</span><span class="n">CWT_t</span><span class="o">&lt;</span><span class="n">DistMatrixType</span><span class="p">,</span> <span class="n">DistMatrixType</span><span class="o">&gt;</span> <span class="n">tmp</span><span class="p">(</span><span class="n">json_tree</span><span class="p">);</span>
</pre></div>
</div>
<p>This functionality is also exposed to the Python layer in two ways.
The first, is straightforward serialize method of sketch objects, and a
corresponding deserialize_sketch on the module level. The following is a
short example.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">S</span> <span class="o">=</span> <span class="n">sketch</span><span class="o">.</span><span class="n">CWT</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">sketch_dict</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>

<span class="n">S_clone</span> <span class="o">=</span> <span class="n">sketch</span><span class="o">.</span><span class="n">deserialize_sketch</span><span class="p">(</span><span class="n">sketch_dict</span><span class="p">)</span>
</pre></div>
</div>
<p>Alternatively, sketch objects also support the Pickle and cPickle modules.
This allows them to be easily used by external libraries or software like Spark.</p>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="ml.html">Machine Learning</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="contributing.html">Contributing</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; Copyright IBM Corporation 2012-2014.  All Rights Reserved.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>